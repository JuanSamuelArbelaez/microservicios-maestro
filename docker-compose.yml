version: '3.8'

services:
  database:
    image: postgres:15
    container_name: postgres-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin_user
      POSTGRES_PASSWORD: supersecurepassword
      POSTGRES_DB: usuariosdb
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database-init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_user -d usuariosdb"]
      interval: 10s
      timeout: 5s
      retries: 6

  data-service:
    build: ./servicio-datos
    container_name: data-service
    restart: unless-stopped
    environment:
      DB_HOST: database
      DB_PORT: 5432
      DB_USER: admin_user
      DB_PASSWORD: supersecurepassword
      DB_NAME: usuariosdb
      OTP_SERVICE_URL: http://otp-service:8084/api/otp
    depends_on:
      - database
    ports:
      - "8082:8082"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl -f http://localhost:8082/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6

  user-service:
    build: ./servicio-usuarios
    container_name: user-service
    restart: unless-stopped
    environment:
      - PUBLIC_KEY_PATH=/app/keys/public-key.pem
      - PRIVATE_KEY_PATH=/app/keys/private-key.pem
      - DATA_SERVICE_URL=http://data-service:8082/api/users
      - AUTH_SERVICE_URL=http://data-service:8082/api/auth
    volumes:
      - ./keys:/app/keys:ro
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      - data-service
    healthcheck:
      test: ["CMD", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6

  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.1
    container_name: zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "nc -z localhost 2181"]
      interval: 10s
      timeout: 5s
      retries: 6

  kafka:
    image: confluentinc/cp-kafka:7.7.1
    container_name: kafka
    restart: unless-stopped
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_OFFSETS_TOPIC_NUM_PARTITIONS: 50
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD", "kafka-topics --list --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - app-network

  notification-service:
    build: ./servicio-notificaciones
    container_name: notification-service
    restart: unless-stopped
    env_file:
      - ./servicio-notificaciones/.env
    ports:
      - "8083:8083"
    networks:
      - app-network
    depends_on:
      - kafka

  notification-orchestrator:
    build: ./orquestador-notificaciones
    container_name: notification-orchestrator
    restart: unless-stopped
    depends_on:
      - kafka
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_PRODUCER_TOPIC: notifications
      KAFKA_CONSUMER_TOPIC: user-events
      KAFKA_GROUP_ID: kafka-listener-group
    ports:
      - "8085:8080"
    networks:
      - app-network

  servicio-otp:
    build: ./servicio-otp
    container_name: otp-service
    restart: unless-stopped
    ports:
      - "8084:8084"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl -f http://localhost:8084/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6

  servicio-perfil:
    build: ./servicio-perfil
    container_name: profile-service
    restart: unless-stopped
    environment:
      - DB_HOST=database
      - DB_PORT=5432
      - DB_USER=admin_user
      - DB_PASSWORD=supersecurepassword
      - DB_NAME=usuariosdb
      - PUBLIC_KEY_PATH=/app/keys/public-key.pem
      - PORT=8087
    volumes:
      - ./keys:/app/keys:ro
    ports:
      - "8087:8087"
    networks:
      - app-network
    depends_on:
      - database
    healthcheck:
      test: ["CMD", "curl -f http://localhost:8087/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka
      - zookeeper
    networks:
      - app-network

  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    restart: unless-stopped
    ports:
      - "8086:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - app-network

  sonarqube:
    image: sonarqube:latest
    container_name: sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - app-network

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config:/etc/loki
      - loki_data:/loki
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    volumes:
      - ./promtail-config:/etc/promtail
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - app-network

  grafana:
    image: grafana/grafana:nightly
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning
    depends_on:
      - loki
      - prometheus
    networks:
      - app-network

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - app-network
    depends_on:
      - blackbox
      - alertmanager

  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: blackbox
    restart: unless-stopped
    ports:
      - "9115:9115"
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox_exporter/config.yml
    networks:
      - app-network

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager:/etc/alertmanager
    networks:
      - app-network
    environment:
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM=${SENDGRID_FROM}

  servicio-gateway:
    build: ./servicio-gateway
    container_name: servicio-gateway
    restart: unless-stopped
    environment:
      SECURITY_URL: "http://user-service:8080/api/v1"
      PROFILE_URL: "http://profile-service:8087/api"
      EVENT_BUS_URL: "http://notification-orchestrator:8080"
      PORT: "8088"
    ports:
      - "8088:8088"
    networks:
      - app-network
    depends_on:
      - user-service
      - data-service
      - notification-orchestrator
      - servicio-perfil

  # ============================================
  # SERVICIOS DE PRUEBAS AUTOMATIZADAS
  # ============================================

  # Pruebas unitarias del servicio OTP
  otp-unit-tests:
    build:
      context: ./servicio-otp
      dockerfile: Dockerfile.test
    container_name: otp-unit-tests
    networks:
      - app-network
    command: |
      sh -c '
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üß™ Ejecutando Pruebas Unitarias - Servicio OTP"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        go test ./... -v
        TEST_EXIT_CODE=$$?
        echo ""
        if [ $$TEST_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Todas las pruebas unitarias pasaron exitosamente"
        else
          echo "‚ùå Las pruebas unitarias fallaron"
          exit 1
        fi
      '
    volumes:
      - ./servicio-otp/src:/app/src
    profiles:
      - testing

  # Pruebas con cobertura
  otp-coverage-tests:
    build:
      context: ./servicio-otp
      dockerfile: Dockerfile.test
    container_name: otp-coverage-tests
    networks:
      - app-network
    command: |
      sh -c '
        echo "üìä Generando reporte de cobertura..."
        go test ./... -v -coverprofile=coverage.out
        go tool cover -html=coverage.out -o /coverage/coverage.html
        go tool cover -func=coverage.out
        echo "‚úÖ Reporte generado en servicio-otp/coverage/coverage.html"
      '
    volumes:
      - ./servicio-otp/src:/app/src
      - ./servicio-otp/coverage:/coverage
    profiles:
      - testing

  # ================================
  # PRUEBAS - SERVICIO NOTIFICACIONES
  # ================================
  notification-tests:
    build:
      context: ./servicio-notificaciones
      dockerfile: Dockerfile.test
    container_name: notification-tests
    environment:
      NODE_ENV: test
    command: npm test
    volumes:
      - ./servicio-notificaciones:/app
      - /app/node_modules
    networks:
      - app-network
    profiles:
      - testing

  notification-coverage:
    build:
      context: ./servicio-notificaciones
      dockerfile: Dockerfile.test
    container_name: notification-coverage
    environment:
      NODE_ENV: test
    command: npm run test:coverage
    volumes:
      - ./servicio-notificaciones:/app
      - /app/node_modules
      - ./servicio-notificaciones/coverage:/app/coverage
    networks:
      - app-network
    profiles:
      - testing

  # ================================
  # PRUEBAS - SERVICIO PERFIL
  # ================================
  profile-tests:
    build:
      context: ./servicio-perfil
      dockerfile: Dockerfile.test
    container_name: profile-tests
    environment:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: test_db
      PUBLIC_KEY_PATH: /tmp/test_public_key.pem
      PORT: 8087
    command: pytest -v --tb=short
    volumes:
      - ./servicio-perfil:/app
    networks:
      - app-network
    profiles:
      - testing

  profile-coverage:
    build:
      context: ./servicio-perfil
      dockerfile: Dockerfile.test
    container_name: profile-coverage
    environment:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: test_db
      PUBLIC_KEY_PATH: /tmp/test_public_key.pem
      PORT: 8087
    command: pytest --cov=. --cov-report=html --cov-report=term
    volumes:
      - ./servicio-perfil:/app
      - ./servicio-perfil/htmlcov:/app/htmlcov
    networks:
      - app-network
    profiles:
      - testing


networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  kafka_data:
  jenkins_home:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  loki_data:
  grafana_data: